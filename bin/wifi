#!/usr/bin/env bash
#
# connect to wifi using creds stored in syncthing
#
# if connecting to open wifi network, use network name as first arg

# needed because sudo will have wrong HOME
# and wifi settings are in $HOME/passwd/wifi/$essid.wifi
home=$(readlink -f $0|cut -f1-3 -d/)
DEFAULT_WIFI=abraham_linksys

# find interface
#IF=$(iwconfig 2>/dev/null|grep -om1 "^w[^ ]*")
IF=$(ip addr|perl -lne 'print $1 if /^\d+: (w[^:]+)/'|sort)
[ -z "$IF" ] && echo 'no interface' && exit 1

# make sure we sudo
[ $(id -u) -ne 0 ] && {
  sudo $0 "$@"
  exit
}

# shut down if already running
killall wpa_supplicant
dhcpcd -k
killall dhcpcd

## start up
# default to home wifi if not args
# otherwise use input arg as essid to find wpasupplicant file
# if no file, assume open wifi
[ $# -eq 0 ] && essid="$DEFAULT_WIFI" || essid="$1"
if test -r $home/passwd/wifi/${essid//[^A-Za-z0-9]/_}.wifi; then
   wpa_supplicant -c $_ -B -i $IF
elif [ $1 == "select" ]; then
  ifconfig $IF up
  iwlist scanning |
     perl -lne 'print $1 if m/ESSID:(.*)/' |
     sort |
     uniq -c |
     sort -rn |
     rofi -dmenu |
     sed -n 's/.*"\(.*\)"/\1/p' | # remove count
     xargs -rI{} wifi "{}"
else
   echo "assume open wifi for '$essid'" >&2
   ifconfig $IF up
   iwconfig $IF essid "$essid"
fi

dhcpcd $IF
